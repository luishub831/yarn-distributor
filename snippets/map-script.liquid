<script>
$(function() {
    function initMap() {
        var mapStyle = [
            {featureType:"all",elementType:"labels.text.fill",stylers:[{saturation:36},{color:"#333333"},{lightness:40}]},
            {featureType:"all",elementType:"labels.text.stroke",stylers:[{visibility:"on"},{color:"#ffffff"},{lightness:16}]},
            {featureType:"all",elementType:"labels.icon",stylers:[{visibility:"off"}]},
            {featureType:"administrative",elementType:"geometry.fill",stylers:[{color:"#fefefe"},{lightness:20}]},
            {featureType:"administrative",elementType:"geometry.stroke",stylers:[{color:"#fefefe"},{lightness:17},{weight:1.2}]},
            {featureType:"landscape",elementType:"geometry",stylers:[{color:"#f5f5f5"},{lightness:20}]},
            {featureType:"poi",elementType:"geometry",stylers:[{color:"#f5f5f5"},{lightness:21}]},
            {featureType:"poi.park",elementType:"geometry",stylers:[{color:"#dedede"},{lightness:21}]},
            {featureType:"road.highway",elementType:"geometry.fill",stylers:[{color:"#4296a9"},{lightness:17}]},
            {featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#ffffff"},{lightness:29},{weight:.2}]},
            {featureType:"road.arterial",elementType:"geometry",stylers:[{color:"#ffffff"},{lightness:18}]},
            {featureType:"road.local",elementType:"geometry",stylers:[{color:"#ffffff"},{lightness:16}]},
            {featureType:"transit",elementType:"geometry",stylers:[{color:"#f2f2f2"},{lightness:19}]},
            {featureType:"water",elementType:"geometry",stylers:[{color:"#e9e9e9"},{lightness:17}]},
            {featureType:"water",elementType:"geometry.fill",stylers:[{color:"#4299a9"}]}
        ];

        var map = new google.maps.Map($('.map-canvas')[0], {
            zoom: 5,
            styles: mapStyle,
            center: new google.maps.LatLng(-25.2744, 133.7751),
            gestureHandling: 'greedy',
            scrollwheel: false,
            zoomControl: true,
            zoomControlOptions: {
                position: google.maps.ControlPosition.TOP_RIGHT
            },
            streetViewControl: false,
            mapTypeControl: false,
            fullscreenControl: false
        });

        var template = Handlebars.compile($('#marker-content-template').html());

        var closeDelayed = false;
        var closeDelayHandler = function(info) {
            return function() {
                $(info.getWrapper()).removeClass('active');
                setTimeout(function() {
                    closeDelayed = true;
                    info.close();
                }, 300);
            }
        };

        function CustomMarker(latlng, map, imageSrc, content) {
            this.latlng = latlng;
            this.imageSrc = imageSrc;
            this.content = content;
            this.setMap(map);
        }

        CustomMarker.prototype = new google.maps.OverlayView();

        CustomMarker.prototype.onAdd = function() {
            var div = document.createElement('div');
            div.className = 'custom-marker';
            div.style.backgroundImage = 'url(' + this.imageSrc + ')';
            div.style.cursor = 'pointer';
            this.div = div;

            var panes = this.getPanes();
            panes.overlayImage.appendChild(div);

            var that = this;
            div.addEventListener('click', function() {
                that.showInfoWindow();
            });
        };

        CustomMarker.prototype.draw = function() {
            var overlayProjection = this.getProjection();
            var position = overlayProjection.fromLatLngToDivPixel(this.latlng);

            var div = this.div;
            div.style.left = position.x + 'px';
            div.style.top = position.y + 'px';
        };

        CustomMarker.prototype.onRemove = function() {
            this.div.parentNode.removeChild(this.div);
            this.div = null;
        };

        CustomMarker.prototype.showInfoWindow = function() {
            var infoWindow = new SnazzyInfoWindow({
                position: this.latlng,
                map: this.getMap(),
                content: this.content,
                wrapperClass: 'custom-window',
                offset: { top: '-10px', left: '25px' }, // Adjust this value to bring the window closer to the marker
                edgeOffset: { top: 10, right: 10, bottom: 10, left: 10 }, // Optional: Adjust these values if needed
                border: false,
                closeButtonMarkup: '<button type="button" class="custom-close">&#215;</button>',
                callbacks: {
                    open: function() {
                        $(this.getWrapper()).addClass('open');
                    },
                    afterOpen: function() {
                        var wrapper = $(this.getWrapper());
                        wrapper.addClass('active');
                        wrapper.find('.custom-close').on('click', closeDelayHandler(infoWindow));
                    },
                    beforeClose: function() {
                        if (!closeDelayed) {
                            closeDelayHandler(infoWindow)();
                            return false;
                        }
                        return true;
                    },
                    afterClose: function() {
                        var wrapper = $(this.getWrapper());
                        wrapper.find('.custom-close').off();
                        wrapper.removeClass('open');
                        closeDelayed = false;
                    }
                }
            });

            infoWindow.open();
        };

        {% for block in section.blocks %}
        (function() {
            var position = new google.maps.LatLng({{ block.settings.latitude }}, {{ block.settings.longitude }});

            var contentData = {
                title: '{{ block.settings.title }}',
                subtitle: '{{ block.settings.subtitle }}',
                bgImg: '{{ block.settings.bg_img | img_url: 'master' }}',
                pinImg: '{{ block.settings.pin_img | img_url: 'master' }}',
                body: `{{ block.settings.body | escape | truncate: 180 }}`,
                link_url: '{{ block.settings.link_url }}',
                link_text: '{{ block.settings.link_text }}'
            };

            var content = template(contentData);

            var marker = new CustomMarker(position, map, '{{ block.settings.pin_img | img_url: "master" }}', content);
        })();
        {% endfor %}
    }

    if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
        google.maps.event.addDomListener(window, 'load', initMap);
    } else {
        $(window).on('load', initMap);
    }
});
</script>
